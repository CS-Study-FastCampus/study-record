# 교착상태

## 교착상태(deadlock)

- 두 개 이상의 프로세스들이 서로가 가진 자원을 기다리며 중단된 상태를 말한다.
- 일어나지 않을 사건을 기다리며 진행이 멈춰 버리는 현상

## 식사하는 철학자들

<img width="337" alt="Untitled" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/ec8f332d-642b-4011-9b77-92b1b0fb5f20">

규칙

1. 왼쪽포크가 사용가능하면 집어든다
2. 오른쪽포크가 사용가능하면 집어든다
3. 왼쪽및 오른쪽 포크를 모두 집어들면 정해진 시간동안 식사를 한다.(식사를하기위한 절대조건)
4. 식사 시간이 끝나면 오른쪽 포크를 내려놓는다.
5. 오른족 포크를 내려놓은 뒤 왼쪽 포크를 내려놓는다.
6. 1번부터 다시 반복한다.

→ 한두사람의 철학자들이나, 포크갯수가 현재놓여져있는개수의 두배수가 아니면야 모두가 동시에 해당규칙으로 식사를 할 수 없다.

서로서로 기다리게된다.

철학자 -  프로세스 혹은 스레드

포크 - 실행에 필요한 자원

식사 - 실행

## 자원할당 그래프

- 프로세스는 원으로, 자원의 종류는 사각형으로 표현
- 사용할 수 있는 자원의 개수는 자원 사각형 내 점으로 표현
- 프로세스가 어떤 자원을 할당 받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시
- 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표를 표시

## 교착상태가 일어난 자원할당 그래프

<img width="846" alt="Untitled 1" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/704b7037-1273-4667-869f-2f482acb87e0">

<img width="465" alt="Untitled 2" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/79f8c084-434f-44da-8c6c-5efb45b4aeb1">

대개 자원 할당 그래프가 원의 형태를 띄고있다는 특징이있다.

다만 사이클유무(원형대기)에 자원의 개수에 따라 사이클이 발생해도 교착상태가 일어나지 않는경우가있다.

각 자원의 개수가 1개이상일경우

사이클이 있는상태에서 데드락

<img width="292" alt="Untitled 3" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/5f1f53ed-84ef-4dba-b16d-d2a31b89e4bd">

사이클이 있지만 데드락이 아닐때

<img width="442" alt="Untitled 4" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/7d718229-8ef3-4bce-9935-1231d67f5932">

## 교착 상태가 발생할 조건 4가지

- 네가지 조건중 하나라도 만족하지 않으면 교착 상태가 발생하지 않는다.
- 네가지 조건을 모두 만족하면 교착상태가 발생한다.

### 1. 상호배제(Mutual exclusion)

- 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 상태

### 2.점유와 대기(Hold and wait)

- 자원을 할당 받은 상태에서 다른 자원을 할당 받기를 기다리는 상태

<img width="714" alt="Untitled 5" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/ea8c6924-5296-441e-9f2a-93c4bb200454">


### 3.비선점(No preemption)

- 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못하는 상태

### 4.원형대기(Circular wait)

- 프로세스들이 원의 형태로 자원을 대기하는 상태
- ex) 프로세스A가 프로세스B의 자원을 요구하고, 프로세스B는 프로세스A의 자원을 요구하는등의 서로가
    
    서로의 자원을 요구하는 상황.
    

## 교착 상태 해결방법

### 교착 상태 예방

- 자원 할당시 교착 상태가 발생하지 않도록 발생 조건중 하나를 없애버리는 방법
- 교착 상태가 발생하지 않응을 보장할 수는 있으나 부작용이 따르는 방식
    
    
    **상호 배제 조건을 없앤다** → 모든 자원을 공유 가능하게 만든다
    
    이론적으론 가능하나 현실적인 방법은 아님
    
    **점유와 대기를 없앤다** → 특정 프로세스의 자원을 모두 할당 혹은 할당하지 않는방식
    
    자원의 활용률을 낮출수 있는 방식
    
    **원형 대기 조건을 없앤다** → 자원에 번호를 붙이고 오름차순으로 할당하는 방식
    
    자원에 번호를 붙이는 작업이 어려운작업이고, 어떤 자원에 어떤번호를 붙이느냐에 따라 활용률이 달라진다.
    
    **비선점 조건을 없앤다** → 선점, 즉 강제로 자원탈취가 가능한상태
    
    선점이 가능한 자원(ex.CPU)에 한해 효과적이지만, 모든 자원이 선점 가능하능한것이 아니라 어느정도 제약이 존재.
    

### 교착 상태 회피

- 안전 상태에서 안전 상태로 움직이는 경우에만 자원을 할당하는 방식
- 항시 안전 상태를 유지하도록 자원을 할당하는 방식
- 은행원 알고리즘
    - 은행에서 모든 고객의 요구가 충족되도록 현금을 할당하는데서 유래
    - 프로세스가 자원을 요구시, 시스템은 자원을 할당한 후엗 안정 상태로 남아있게 되는지 사전에 검사하여 교착 상태를 회피
    - 

안전순서열

- 교착 상태 없이 안전하게 프로세스들에 자원을 할당 할 수 있는 순서

안전상태

- 교착 상태 없이 모든 프로세스가 자원을 할당 받고 종료될 수 있는 상태

불안전 상태

- 교착 상태가 발생할 수도 있는 상태

<img width="522" alt="Untitled 6" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/f2bd3954-5be5-4910-bacf-ebbbddd8cc68">

프로세스 P1,P2,P3가 모두 최대로 자원을 요구한 최악의 상황을 가정시

안전 순서열  P2 → P1 → P3 대로 할당하면 모든 프로세스가 실행 가능

불안전의 예시

위의 예시에서 운영체제가 P3에게 자원하나를 내줄경우를 가정

<img width="488" alt="Untitled 7" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/28f975bd-6fd7-4a19-9b7b-83c0a372b5c2">

똑같은 상황을 가정시(자원을 최대로 요구하는)

P2의 작업을 끝내도

남은자원으로는 나머지 프로세스들의 요구를 들어줄수없는경우 (교착상태 발생위험)

### 교착 상태 검출 후 회복

- 교착 상태의 발생을 인정하고 사후에 조치하는 방식
- 프로세스가 자원을 요구하면 일단 할당, 교착상태가 검출되면 회복
- 선점을 통한 회복과, 프로세스 강제 종료를 통한 회복이 존재한다.
    
    **선점을 통한 회복**
    
    - 교착 상태가 검출이 됬다고 가정시, 해결될때까지 한 프로세스씩 자원을 몰아주는 방식
    
    **프로세스 강제 종료를 통한 회복**
    
    - 교착 상태에 놓인 프로세스를 모두 강제종료한다.(다만 그만큼 작업내역을 잃을 위험성이있다)
    - 교착 상태가 해결될 때까지 한 프로세스씩 강제 종료
        
        교착상태의 회복유무를 계속 확인해봐야되기 때문에 그만큼의 오버헤드가 일어날 수 있으나
        
        작업내역을 잃는정도를 최소화할 수 있다는 장점이있다.
        

### 교착상태 무시

- 교착상태를 굳이 해결할 필요가 있는가?
    - 교착상태는 드물게 발생하는만큼 발생가능성이 극히 적고
    - 교착상태를 피하고 처리하기위한 비용이 많이 들어간다.

- **타조알고리즘**
<img width="362" alt="Untitled 8" src="https://github.com/WooSeok77/Algorithm_BOJ-PGM/assets/80507195/d9ff9318-09e4-4c17-848d-fb17cf6c9ad1">

- 타조가 머리를 모래 속에 박고 자신이 보이지 않는 척하는 것에 빗댄 알고리즘
- 교착상태관련하여 무시를 비롯 아무대책을 취하지 않는 접근법
- 예시로 Unix와 Window등의 거의 모든 운영체제에서 이방법을 채택
    - 의심가는 스레드를 종료시키거나 시스템 재시작
